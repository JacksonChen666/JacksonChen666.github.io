<!DOCTYPE html>
<html>
<head>
    <title>JacksonChen666 - Looper Commands</title>
    <meta name="viewport" content="width=device-width initial-scale=1">
    <style type="text/css">
        html{font-family:arial;font-size:1.2rem;}
        input:invalid{background-color:red;}
        textarea{width:99%;height:17px;resize:none;max-height:200px;}
        #percent{width:40px;}
    </style>
    <script type="text/javascript">
        function createCommand(form) {
            console.log("%cScreenshot should start here", "font-size:1.5rem;");
            var command = [];
            var fileCMD = [];

            var preVid = outOrNull(form.preVideo.value);
            var preVidSec = toSeconds(form.preVideoLength.value);

            var loopVid = form.loopVideo.value;
            var loopVidSec = toSeconds(form.loopVideoLength.value);

            var postVid = outOrNull(form.postVideo.value);
            var postVidSec = toSeconds(form.postVideoLength.value);

            var totalSec = toSeconds(form.videoLength.value);
            var curSec = 0;

            var outName = form.outName.value;
            var processSub = form.proSub.checked;
            var lossTrigger = form.triggerLoss.value;
            var extraOptions = outOrNull(form.extraOptions.value);
            var TEMP;

            if (!processSub) {
                fileCMD.push(": > concat.txt");
            }

            if (preVid) {
                TEMP = "echo \"file '" + preVid + "'\"";
                if (!processSub) {
                    TEMP += " >> concat.txt";
                }
                fileCMD.push(TEMP);
                curSec += preVidSec;
            }
            if (postVid) {
                curSec += postVidSec;
            }

            var tt = totalSec - curSec;
            tt = !(loopVidSec % 1) ? tt / loopVidSec : tt * loopVidSec; // i mean, it's the greatest i've done
            curSec += tt;
            // There is a slight issue when the looping video length is .75 seconds and the target is a minute, it gives only 45 loops (which is less than a minute)
            console.log(totalSec);
            console.log(curSec);

            var loss = -((100 / totalSec) * curSec) + 100;
            if (loss >= lossTrigger || -loss >= lossTrigger) {
                console.log("LOSS!");
                // But this thing is able to fix the .75 seconds problem by continuing to loop until it's the closest (the math is kept because that easily gets us closer to what we want)
                while (totalSec > curSec) {
                    tt += 1;
                    curSec += loopVidSec;
                }

                console.log(totalSec);
                console.log(curSec);

                while (totalSec < curSec) {
                    tt -= 1;
                    curSec -= loopVidSec;
                }

                console.log(totalSec);
                console.log(curSec);
                console.log("LOSS!");
            }

            if (!processSub) {
                fileCMD.push("for i in {0.." + Math.round(tt) + "}; do echo \"file '" + loopVid + "'\" >> concat.txt; done");
            }
            else {
                fileCMD.push("for i in {0.." + Math.round(tt) + "}; do echo \"file '" + loopVid + "'\"; done");
            }

            if (postVid) {
                TEMP = "echo \"file '" + postVid + "'\""
                if (!processSub) {
                    TEMP += " >> concat.txt";
                }
                fileCMD.push(TEMP);
            }

            fileCMD = fileCMD.join("; ");
            if (!processSub) {
                command.push(fileCMD + ";");
            }
            command.push("ffmpeg -f concat -safe 0 -i");
            if (processSub) {
                command.push("<(" + fileCMD + ")");
            }
            else {
                command.push("concat.txt");
            }

            if (extraOptions) { 
                command.push(form.extraOptions.value);
            }
            command.push("\"" + outName + "\"");

            var output = document.getElementById("output");
            output.value = command.join(" ");
            console.debug(
                "Variables:\n" +
                "Command array: " + command + "\n" +
                "File command array" + fileCMD + "\n" +
                "Pre-video name: " + preVid + "\n" +
                "Pre-video length: " + preVidSec + "\n" +
                "Loop-video name: " + loopVid + "\n" +
                "Loop-video length: " + loopVidSec + "\n" +
                "Post-video name: " + postVid + "\n" +
                "Post-video length: " + postVidSec + "\n" +
                "User requested seconds: " + totalSec + "\n" +
                "Current seconds: " + curSec + "\n" +
                "Output name: " + outName + "\n" +
                "Process substitution supported: " + processSub + "\n" +
                "Loss percent trigger: " + lossTrigger + "\n" +
                "Extra options: " + extraOptions + "\n" +
                "Output command: " + output.value + "\n" +
                "TEMP: " + TEMP + "\n"
            )
            console.log("%cScreenshot should end here", "font-size:1.5rem;");
            auto_grow(output);
        }

        function getPercentageChange(oldNumber, newNumber){
            var decreaseValue = oldNumber - newNumber;

            return (decreaseValue / oldNumber) * 100;
        }

        function validation(form) {
            var preVid = outOrNull(form.preVideo.value);
            var preVidSec = outOrNull(form.preVideoLength.value);

            var postVid = outOrNull(form.postVideo.value);
            var postVidSec = outOrNull(form.postVideoLength.value);

            if (preVid != null) {
                var t = preVidSec == null;
                if (t) {
                    form.preVideoLength.focus();
                    form.preVideoLength.style.backgroundColor = "red";
                    alert("You are missing the length for the pre-video.");
                    setTimeout(function() { document.formLol.preVideoLength.style.backgroundColor = null; }, 5000);
                }
                return t;
            }
            else if (postVid != null) {
                var t = postVidSec == null;
                if (t) {
                    alert("You are missing the length for the post-video.");
                }
                return t;
            }
            return true;
        }

        function outOrNull(input) {
            return input == "" ? null : input;
        }

        function toSeconds(string) {
            if (outOrNull(string) == null) {
                return null;
            }
            const timeRegex = /(\d\d):(\d\d):(\d\d)[.,](\d{2,})/;
            var t = timeRegex.exec(string);
            for (var i = 1; i < t.length; i++) {
                t[i] = parseInt(t[i]);
            }
            return (t[1] * 60 + t[2]) * 60 + t[3] + (parseFloat("0." + t[4].toString()));
        }

        function auto_grow(element) {
            element.style.height = "5px";
            element.style.height = (element.scrollHeight) + "px";
        }
    </script>
</head>
<body>
    <h1>Looper commands</h1>
    <h3>What's this?</h3>
    <p>Basically for a future video (not yet made) on how to loop something extremely long (and also high quality, e.g. Yoshi 1 hours). I used the command line to do the looping, but I think there are some people who want to do this, and may not be familiar with the command line (and I hate it when they don't know how to use tech). So I made this exact tool that "generates" a command that would help the user loop a video. <small>i also made this at 2 am it's fine</small></p>
    <p>do note that this will only work with the most common bash and zsh, so if you're on windows, you might want to write it into a file.</p>
    <form action="javascript:createCommand(this.formLol);" method="post" name="formLol" onsubmit="validation(this);">
        <label>Pre-video file name / path (Optional)</label><input type="text" name="preVideo"><br>
        <label>Pre-video length (Required if pre-video is included)</label><input type="text" pattern="\d\d:\d\d:\d\d[.,]\d{2,}" placeholder="hh:mm:ss.ms" name="preVideoLength"><br>
        <br>
        <label>Looping video file name / path</label><input type="text" name="loopVideo" required><br>
        <label>Looping video length</label><input type="text" pattern="\d\d:\d\d:\d\d[.,]\d{2,}" placeholder="hh:mm:ss.ms" name="loopVideoLength" required><br>
        <br>
        <label>Post-video file name / path (Optional)</label><input type="text" name="postVideo"><br>
        <label>Post-video length (Required if post-video included)</label><input type="text" pattern="\d\d:\d\d:\d\d[.,]\d{2,}" placeholder="hh:mm:ss.ms" name="postVideoLength"><br>
        <br>
        <label>Total wanted video length</label><input type="text" name="videoLength" pattern="\d\d:\d\d:\d\d[.,]\d{2,}" required placeholder="hh:mm:ss.ms"><br>
        <label>Output file name</label><input type="text" name="outName" required><br>
        <label>Add one more loop if over </label><input type="number" name="triggerLoss" placeholder="%" min="0" max="100" value="20" id="percent"><label>% of time is lost</label><br>
        <label>Shell supports <a href="https://superuser.com/a/1060002">process substitution</a> (bash and zsh works, also requires full path to file)</label><input type="checkbox" name="proSub"><br>
        <label>Custom extra ffmpeg options</label><input type="text" name="extraOptions"><br>
        <p>Note: This will slightly down your expectation if it cannot achieve perfectly.</p>
        <input type="submit" value="Create command">
    </form>
    <textarea readonly placeholder="Output command. Click to copy." onclick="this.setSelectionRange(0, this.value.length);document.execCommand('copy');" id="output"></textarea>
</body>
</html>